version: '3.9'

services:
  test-runner:
    image: python:3.12-slim
    working_dir: /app
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:RubyAnita2018@db:5432/cricksy_scorer
      CRICKSY_IN_MEMORY_DB: "0"
      PYTHONUNBUFFERED: "1"
    volumes:
      - ./:/app
      - pip-cache:/root/.cache/pip
    command: >
      bash -lc "pip install --no-input --upgrade pip && \
      pip install --no-input -r backend/requirements.txt && \
      cd backend && alembic upgrade head && pytest -q"

volumes:
  pip-cache:
