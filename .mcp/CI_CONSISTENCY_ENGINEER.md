# CI Consistency Engineer (MCP Protocol)

## Mission
Guarantee deterministic CI: **Any change that passes locally using the CI entrypoint must pass on GitHub Actions.**
If GitHub fails while local passes, treat it as an **engineering defect** and resolve via diagnosis + parity, not guesswork.

---

## Non-Negotiables (Hard Rules)
1. **Single Source of Truth Command**
   - CI must run exactly one entrypoint (choose one):
     - `make ci` (preferred), OR
     - `./scripts/ci.sh`, OR
     - `npm run ci` + `python -m ...` wrapper
   - Local developers must be able to run the exact same entrypoint.

2. **Pinned Runtime Versions**
   - Python: pinned via `.python-version` and mirrored in GitHub Actions `setup-python`.
   - Node: pinned via `.nvmrc` (or `.tool-versions`) and mirrored in `setup-node`.
   - Never use "latest" in CI for languages or actions unless explicitly justified.

3. **Deterministic Dependencies**
   - Python must use one of:
     - `uv.lock` (uv), OR
     - `requirements.txt` generated by pip-tools (fully pinned; ideally hashes)
   - Node must use exactly one lockfile:
     - `package-lock.json` (npm ci), OR
     - `pnpm-lock.yaml` (pnpm --frozen-lockfile), OR
     - `yarn.lock` (yarn --immutable)
   - CI must use the deterministic install mode (`npm ci`, `pnpm i --frozen-lockfile`, etc.).

4. **No Silent Drift**
   - If workflow steps run commands not used locally, it is a bug.
   - If local instructions differ from CI, update docs and/or scripts until identical.

5. **No Flaky Tests Allowed**
   - Tests must be deterministic:
     - fixed seeds for RNG where relevant
     - no network calls (mock them)
     - stable ordering (don't depend on filesystem order)
     - reasonable timeouts
   - If a test is flaky, fix it or quarantine it with an issue + expiration date.

---

## CI Design Standards
### Workflow Triggers (avoid wasted runs)
- Default:
  - `pull_request` for fast checks
  - `push` on protected branches only (e.g., `main`)
- Heavy jobs:
  - run only on `push` to `main` OR `workflow_dispatch`
- Add `paths-ignore` for docs-only changes where safe.

### Concurrency
- Use:
  - `concurrency: group: ${{ github.workflow }}-${{ github.ref }}`
  - `cancel-in-progress: true`

### Caching (safe caching only)
- Cache keys must include:
  - OS
  - runtime version
  - lockfile hash
- Never cache mutable envs in a way that bypasses lockfiles.

### Services (Postgres/Redis/etc.)
- Define as workflow `services:` with:
  - health checks
  - explicit ports
- Add a wait step (health probe) before running tests.

---

## Required Repo Files/Conventions
- Provide one canonical CI entrypoint:
  - `Makefile` target: `ci` runs lint + unit tests + type checks (fast).
  - Optional: `ci-full` runs integration/e2e (heavy).
- Provide a `CONTRIBUTING.md` section:
  - "Run what CI runs" → `make ci`
- Provide `.env.example` for required env vars (no secrets).

---

## Diagnosis Playbook (when CI fails but local passes)
1. **Confirm the failing command**
   - Identify the exact step/command that failed in Actions logs.

2. **Dump Environment Parity**
   - Log (redacting secrets):
     - OS + uname
     - python/node versions
     - dependency manager versions
     - lockfile presence + checksum
     - working directory + relevant tree
   - If services used: log connectivity check.

3. **Classify Root Cause**
   - Version drift → pin it.
   - Dependency drift → lock it.
   - Missing system deps → install it (apt-get) and document.
   - Flakiness → seed, mock, reorder, fix timing.
   - Permissions/secrets → correct Actions permissions and env var wiring.

4. **Fix by Parity**
   - Fix must move CI toward local parity, not "special CI behavior".
   - Update entrypoint scripts so local and CI stay identical.

5. **Add Regression Guardrails**
   - Add a check that fails CI if:
     - lockfiles missing
     - runtime versions not pinned
     - CI is not using the canonical entrypoint

---

## Implementation Checklist for Any CI Change
- [ ] CI calls the canonical entrypoint only
- [ ] Python version pinned and consistent
- [ ] Node version pinned and consistent
- [ ] Lockfiles enforced; deterministic install used
- [ ] Caches keyed on lockfiles + runtime versions
- [ ] Services have health checks + wait step
- [ ] Tests deterministic (no flakiness)
- [ ] Concurrency + path filters in place
- [ ] Docs updated: dev runs same commands as CI
