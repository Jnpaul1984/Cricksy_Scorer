name: Deploy Backend

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  test-backend-postgres:
    name: Test Backend (Postgres)
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: cricksy
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test -d cricksy"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      DATABASE_URL: postgresql+asyncpg://test:test@localhost:5432/cricksy
      APP_SECRET_KEY: ${{ secrets.APP_SECRET_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: Install backend dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install alembic pytest

      - name: Run Alembic migrations
        working-directory: backend
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          alembic upgrade head

      - name: Run backend tests
        working-directory: backend
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          PYTHONPATH: ${{ github.workspace }}/backend
        run: |
          pytest -v

  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: [test-backend-postgres]
    env:
      AWS_REGION: us-east-1
      ECR_REPOSITORY: cricksy-backend
      ECS_CLUSTER: cricksy-ai-cluster
      ECS_SERVICE: cricksy-ai-backend-service

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build backend image
        working-directory: backend
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
        run: |
          docker build -f Dockerfile -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest .
          docker tag $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:${GITHUB_SHA}

      - name: Push backend image
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
        run: |
          docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest
          docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:${GITHUB_SHA}

      - name: Force new ECS deployment
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --force-new-deployment

      - name: Wait for service to stabilize
        run: |
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }}

      - name: Dump ECS events and stopped tasks
        if: failure()
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          ECS_CLUSTER: ${{ env.ECS_CLUSTER }}
          ECS_SERVICE: ${{ env.ECS_SERVICE }}
        run: |
          set -euo pipefail

          echo "=== ECS service events ==="
          aws ecs describe-services \
            --cluster "$ECS_CLUSTER" \
            --services "$ECS_SERVICE" \
            --region "$AWS_REGION" \
            --query 'services[0].events' -o json || true

          echo
          echo "=== Current service summary (taskDefinition, deployments) ==="
          aws ecs describe-services \
            --cluster "$ECS_CLUSTER" \
            --services "$ECS_SERVICE" \
            --region "$AWS_REGION" \
            --query 'services[0].[taskDefinition,deployments]' -o json || true

          echo
          echo "=== Stopped tasks for service ==="
          STOPPED_TASKS=$(aws ecs list-tasks \
            --cluster "$ECS_CLUSTER" \
            --service-name "$ECS_SERVICE" \
            --desired-status STOPPED \
            --region "$AWS_REGION" \
            --output text || true)

          if [ -z "${STOPPED_TASKS:-}" ]; then
            echo "No stopped tasks found"
            exit 0
          fi

          echo "Stopped task ARNs: $STOPPED_TASKS"
          echo
          echo "=== Describe stopped tasks (stoppedReason, exitCode, containers) ==="
          aws ecs describe-tasks \
            --cluster "$ECS_CLUSTER" \
            --tasks $STOPPED_TASKS \
            --region "$AWS_REGION" \
            --query 'tasks[*].{Arn:taskArn,LastStatus:lastStatus,StoppedReason:stoppedReason,Containers:containers}' -o json || true

          echo
          echo "=== Task definition & logConfiguration (if present) ==="
          TASK_DEF_ARN=$(aws ecs describe-services \
            --cluster "$ECS_CLUSTER" \
            --services "$ECS_SERVICE" \
            --region "$AWS_REGION" \
            --query 'services[0].taskDefinition' --output text || true)

          if [ -n "$TASK_DEF_ARN" ] && [ "$TASK_DEF_ARN" != "None" ]; then
            aws ecs describe-task-definition \
              --task-definition "$TASK_DEF_ARN" \
              --region "$AWS_REGION" \
              --query 'taskDefinition.containerDefinitions[*].logConfiguration' -o json || true

            # try to locate awslogs group/stream-prefix for the first container
            LOG_GROUP=$(aws ecs describe-task-definition \
              --task-definition "$TASK_DEF_ARN" \
              --region "$AWS_REGION" \
              --query 'taskDefinition.containerDefinitions[0].logConfiguration.options."awslogs-group"' --output text 2>/dev/null || true)

            LOG_STREAM_PREFIX=$(aws ecs describe-task-definition \
              --task-definition "$TASK_DEF_ARN" \
              --region "$AWS_REGION" \
              --query 'taskDefinition.containerDefinitions[0].logConfiguration.options."awslogs-stream-prefix"' --output text 2>/dev/null || true)

            if [ "$LOG_GROUP" != "None" ] && [ -n "$LOG_GROUP" ]; then
              echo
              echo "=== CloudWatch log streams matching stopped tasks (log group: $LOG_GROUP) ==="
              for arn in $STOPPED_TASKS; do
                task_id=${arn##*/}
                aws logs describe-log-streams \
                  --log-group-name "$LOG_GROUP" \
                  --query "logStreams[?contains(logStreamName, \`$task_id\`)].logStreamName" -o json --region "$AWS_REGION" || true
              done
              echo
              echo "If you want to fetch events from a matching log stream, add logs:GetLogEvents and logs:DescribeLogStreams to the deploy role and I can expand this step to print recent events."
            else
              echo "No awslogs configuration found in task definition or unable to determine log group."
            fi
          else
            echo "No taskDefinition ARN found for the service."
          fi
