#!/usr/bin/env bash# ==============================================================================# Cricksy Scorer - Local CI Runner (Bash)# ==============================================================================# Replicates GitHub Actions CI workflows locally before pushing to main.# Safe execution: READ-ONLY checks, no auto-fixes, no file modifications.## Usage:#   ./scripts/ci_local.sh                    # Run all checks#   ./scripts/ci_local.sh --skip-precommit   # Skip pre-commit hooks#   ./scripts/ci_local.sh --skip-frontend    # Backend only#   ./scripts/ci_local.sh --skip-backend     # Frontend only# ==============================================================================set -euo pipefail# ==============================================================================# Configuration# ==============================================================================SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"REPO_ROOT="$(dirname "$SCRIPT_DIR")"BACKEND_DIR="$REPO_ROOT/backend"FRONTEND_DIR="$REPO_ROOT/frontend"VENV_ACTIVATE="$REPO_ROOT/.venv/bin/activate"# Environment variables (matches ci.yml)export CRICKSY_IN_MEMORY_DB=1export DATABASE_URL="sqlite+aiosqlite:///:memory:?cache=shared"export APP_SECRET_KEY="test-secret-key"export PYTHONPATH="$REPO_ROOT"# ==============================================================================# Parse Arguments# ==============================================================================SKIP_FRONTEND=falseSKIP_BACKEND=falseSKIP_PRECOMMIT=falsefor arg in "$@"; do    case $arg in        --skip-frontend)            SKIP_FRONTEND=true            ;;        --skip-backend)            SKIP_BACKEND=true            ;;        --skip-precommit)            SKIP_PRECOMMIT=true            ;;        *)            echo "Unknown argument: $arg"            echo "Usage: $0 [--skip-precommit] [--skip-frontend] [--skip-backend]"            exit 1            ;;    esacdone# ==============================================================================# Results Tracking# ==============================================================================declare -a RESULTS=()add_result() {    local job="$1"    local status="$2"    RESULTS+=("$job|$status")}show_summary() {    echo ""    echo "=============================================================================="    echo "CI LOCAL RUNNER - SUMMARY"    echo "=============================================================================="    echo ""        printf "%-30s %s\n" "Job" "Status"    printf "%-30s %s\n" "---" "------"        local failures=0    local skipped=0    local passed=0        for result in "${RESULTS[@]}"; do        IFS='|' read -r job status <<< "$result"        printf "%-30s %s\n" "$job" "$status"                case "$status" in            FAIL) ((failures++)) ;;            SKIP) ((skipped++)) ;;            PASS) ((passed++)) ;;        esac    done        echo ""    echo "Total: ${#RESULTS[@]} | Passed: $passed | Failed: $failures | Skipped: $skipped"        if [ "$failures" -gt 0 ]; then        echo ""        echo "[FAIL] CI checks failed - fix issues before pushing to main"        echo ""        exit 1    else        echo ""        echo "[PASS] All CI checks passed - safe to push to main"        echo ""        exit 0    fi}# ==============================================================================# Prerequisites# ==============================================================================check_venv_activation() {    echo ""    echo "[CHECK] Virtual environment..."        if [ ! -f "$VENV_ACTIVATE" ]; then        echo "[FAIL] $VENV_ACTIVATE not found"        echo "Create venv with: python -m venv .venv"        return 1    fi        # shellcheck disable=SC1090    source "$VENV_ACTIVATE"    echo "[PASS] Virtual environment activated"    return 0}# ==============================================================================# Pre-commit Job# ==============================================================================run_precommit() {    echo ""    echo "=============================================================================="    echo "[JOB] Pre-commit Hooks (CHECK-ONLY)"    echo "=============================================================================="    echo ""        cd "$REPO_ROOT"        if ! command -v pre-commit &> /dev/null; then        echo "[FAIL] pre-commit not installed"        echo "Install with: pip install pre-commit"        add_result "Pre-commit" "FAIL"        return 1    fi        echo "Running: pre-commit run --all-files --show-diff-on-failure"    if ! pre-commit run --all-files --show-diff-on-failure; then        echo ""        echo "[FAIL] Pre-commit hooks failed"        add_result "Pre-commit" "FAIL"        return 1    fi        echo "[PASS] Pre-commit hooks passed"    add_result "Pre-commit" "PASS"    return 0}# ==============================================================================# Backend Jobs# ==============================================================================run_backend_lint() {    echo ""    echo "=============================================================================="    echo "[JOB] Backend Lint"    echo "=============================================================================="    echo ""        cd "$BACKEND_DIR"        echo "[1/3] ruff check ."    if ! ruff check .; then        echo "[FAIL] Ruff lint errors found"        add_result "Backend: Ruff Lint" "FAIL"        return 1    fi    echo "[PASS] Ruff lint"        echo ""    echo "[2/3] ruff format --check ."    if ! ruff format --check .; then        echo "[FAIL] Code needs formatting"        add_result "Backend: Ruff Format" "FAIL"        return 1    fi    echo "[PASS] Ruff format"        echo ""    echo "[3/3] mypy --config-file pyproject.toml --explicit-package-bases ."    if ! mypy --config-file pyproject.toml --explicit-package-bases .; then        echo "[FAIL] Type checking errors"        add_result "Backend: MyPy" "FAIL"        return 1    fi    echo "[PASS] MyPy"        add_result "Backend: Lint" "PASS"    return 0}run_backend_tests() {    echo ""    echo "=============================================================================="    echo "[JOB] Backend Tests"    echo "=============================================================================="    echo ""        cd "$BACKEND_DIR"        echo "Running: pytest -q"    if ! pytest -q; then        echo ""        echo "[FAIL] Tests failed"        add_result "Backend: Tests" "FAIL"        return 1    fi        echo "[PASS] Tests passed"    add_result "Backend: Tests" "PASS"    return 0}# ==============================================================================# Frontend Jobs# ==============================================================================run_frontend_build() {    echo ""    echo "=============================================================================="    echo "[JOB] Frontend Build"    echo "=============================================================================="    echo ""        cd "$FRONTEND_DIR"        echo "[1/3] npm ci"    if ! npm ci; then        echo "[FAIL] npm ci failed"        add_result "Frontend: npm ci" "FAIL"        return 1    fi    echo "[PASS] npm ci"        echo ""    echo "[2/3] npm run type-check"    if ! npm run type-check; then        echo "[FAIL] Type-check failed"        add_result "Frontend: Type-check" "FAIL"        return 1    fi    echo "[PASS] Type-check"        echo ""    echo "[3/3] npm run build-only"    export VITE_API_BASE="http://localhost:8000"    if ! npm run build-only; then        echo "[FAIL] Build failed"        add_result "Frontend: Build" "FAIL"        return 1    fi    echo "[PASS] Build"        add_result "Frontend: Build" "PASS"    return 0}# ==============================================================================# Main Execution# ==============================================================================main() {    echo ""    echo "=============================================================================="    echo "CRICKSY SCORER - LOCAL CI RUNNER"    echo "=============================================================================="    echo ""        # Activate venv (required for backend tools)    if [ "$SKIP_BACKEND" = false ]; then        if ! check_venv_activation; then            add_result "Prerequisites" "FAIL"            show_summary        fi    fi        # Pre-commit (runs by default unless --skip-precommit)    if [ "$SKIP_PRECOMMIT" = false ]; then        run_precommit || true    else        add_result "Pre-commit" "SKIP"    fi        # Backend jobs    if [ "$SKIP_BACKEND" = false ]; then        run_backend_lint || true        run_backend_tests || true    else        add_result "Backend" "SKIP"    fi        # Frontend jobs    if [ "$SKIP_FRONTEND" = false ]; then        run_frontend_build || true    else        add_result "Frontend" "SKIP"    fi        # Show summary and exit    show_summary}# Run mainmain
